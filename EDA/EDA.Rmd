---
title: "EDA"
output:
  html_document:
    df_print: paged
---

```{r setup, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

load_reqs <- function(reqs) {
  for(pkg in reqs) {
    if (!(pkg %in% installed.packages())) { install.packages(pkg) }
    suppressPackageStartupMessages(library(pkg, character.only = T))
  }
}

# ADD LIBRARIES HERE
load_reqs(c("tidyr", "dplyr", "data.table", "purrr", "ggplot2", "corrplot", "gridExtra", "grid", "cowplot", "highcharter", "plotly", "ggpubr", "RColorBrewer"))
```

```{r echo=FALSE, warning=FALSE}
train <- read.csv('../data/BankCamp_train.csv')
submission <- read.csv('../data/BankCamp_test.csv')
```

### Check if there are any missing values in the training set and the submission set

```{r echo=TRUE, warning=FALSE}
any(is.na(train))
any(is.na(submission))
```

**As both return FALSE, there are no missing values**

***

### Check for the structure of the dataset
```{r echo=TRUE, warning=FALSE}
glimpse(train)
glimpse(submission)
```

**Comparing to training set with the submission set, we can tell the target variable is y**

***

#### Check for the factor levels of y
```{r echo=TRUE, warning=FALSE}
unique(train$y)
```

**As shown, it returns only yes and no, so it's a binary classification problem**

***

#### Check for imbalance
```{r echo=TRUE, warning=FALSE}
target_df <- data.frame(table(train$y))
colnames(target_df) <- c("target", "count")
ggplotly( 
  ggplot(data=target_df, aes(x=target, y=count, fill=target)) +
    geom_bar(position = 'dodge', stat='identity', alpha=0.5) +
    scale_fill_manual("targe t", values = c("yes" = "dodgerblue", "no"="firebrick1")) +
    theme_classic()
)

nrow(subset(train, y =='yes')) / nrow(train)
```

**11% ,  no over/under-sampling needed**

***

#### Numerical Features
```{r echo=FALSE, fig.height=6, warning=FALSE}

numeric_vars <- unlist(lapply(train, is.numeric)) 
histograms = list()
densties = list()

for (i in colnames(train[numeric_vars])){
  histograms[[i]] <-
    ggplot(
      train[numeric_vars],
      aes_string(x=i,fill=train$y)) +
      geom_histogram(bins = 35) +
      theme_bw(base_size = 13)+
      labs(fill = "Target")
  
  # print(
  #     ggplotly(
  #     ggdensity(train, x = i, add = "mean",
  #     color = "y", fill = "y",
  #     palette = c("#0073C2FF", "#FC4E07"))
  #     )
  # )
}
plot_grid(plotlist = histograms, ncol = 2)

# Render the outputs
# for(j in 1:length(histograms)){
#   h <- histograms[[j]]
#   print(ggplotly(h))
# }
```

**As shown from the hists, most of the numerical features are heavily skewed, and need to be normalized**

***

#### Categorical Features
```{r echo=FALSE, fig.height=14, warning=FALSE}

cat_vars <- unlist(lapply(train, is.factor)) 
barPlots = list()
for (i in colnames(train[cat_vars])){
  if(i != 'y') {
      barPlots[[i]] <-
        ggplot(
          train[cat_vars],
          aes_string(x=i,fill=train$y)) +
          geom_bar() +
          theme_bw(base_size = 13)+
          labs(fill = "Target")
  }
}
plot_grid(plotlist = barPlots, ncol = 1)
```

**As shown from the hists, most of the numerical features are heavily skewed, and need to be normalized**

***

#### Correlation between two numerical features

```{r echo=TRUE, warning=FALSE}
train_num <- dplyr::select_if(train, is.numeric)
res <- cor(train_num)
corrplot.mixed(
          res,
          upper="circle",
          lower="number",
          tl.col = "black",
          number.cex = .8,
          tl.cex=.8)
```

**As shown from the result, there are no strong correlations between most of the pairs**

**Except the one for pdays and previous = 0.54**


```{r}

data<- aggregate(train$age, by=list(job = train$job, target = train$y), FUN = mean)
data <- dcast(data, job ~ target)

rnames <- data[,1]
mat_data <- data.matrix(data[,2:ncol(data)])

rownames(mat_data) <- rnames
my_palette <- colorRampPalette(c("red", "yellow", "green",  "black"))(n = 299)

my_palette <- colorRampPalette(c("red", "yellow", "green", "black"))(n = 299)
col_breaks = c(seq(-1,0,length=100), # for red
seq(0,0.8,length=100),  # for yellow
seq(0.81,1,length=100)) # for green

data
heatmap(mat_data,
  margins =c(12,12),     # widens margins around plot
    col=my_palette,       # use on color palette defined earlier
   breaks=col_breaks    # enable color transition at specified limits
)

```

```{r}

data<- aggregate(train$age, by=list(education = train$education, target = train$y), FUN = mean)
data <- dcast(data, education ~ target)

rnames <- data[,1]
mat_data <- data.matrix(data[,2:ncol(data)])

rownames(mat_data) <- rnames
my_palette <- colorRampPalette(c("red", "yellow", "green"))(n = 299)

my_palette <- colorRampPalette(c("red", "yellow", "green"))(n = 299)
col_breaks = c(seq(-1,0,length=100), # for red
seq(0,0.8,length=100),  # for yellow
seq(0.81,1,length=100)) # for green

data
heatmap(mat_data,
  margins =c(12,12),     # widens margins around plot
    col=my_palette,       # use on color palette defined earlier
   breaks=col_breaks    # enable color transition at specified limits
)

```

```{r}
# ggplotly(
  ggplot(train, aes(x=previous, y=pdays, color=poutcome)) +
    geom_point(aes(size = poutcome), alpha = 0.15 ) +
    scale_size_discrete(range = c(3, 7))+
    scale_colour_hue()+
    theme_classic()
# )
```
